
Humberto Melo <1bertom15@gmail.com>
21:28 (0 minutes ago)
to me

<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor 3D - Acesso Restrito</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#0f172a',
                        darkcard: '#1e293b',
                        darkinput: '#334155',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .scrollable-list { max-height: 30vh; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #4f46e5 #e5e7eb; }
        .project-table-container { max-height: 40vh; overflow-y: auto; }
        .dark .scrollable-list { scrollbar-color: #6366f1 #334155; }
    </style>
</head>
<body class="p-4 md:p-8 text-slate-800 bg-[#f4f7f9] dark:bg-darkbg dark:text-slate-100 transition-colors duration-300">

    <div id="login-screen" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-[100]">
        <div class="bg-white dark:bg-darkcard p-8 rounded-2xl shadow-2xl w-full max-w-xs text-center border border-slate-200 dark:border-slate-700">
            <div class="mb-4 bg-indigo-100 dark:bg-indigo-900 w-16 h-16 rounded-full flex items-center justify-center mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600 dark:text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
            </div>
            <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-2">Gestor 3D</h2>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">√Årea Restrita</p>
           
            <form id="login-form" class="space-y-3">
                <input type="password" id="access-code" placeholder="PIN" class="w-full p-3 text-center text-lg tracking-widest bg-slate-50 dark:bg-darkinput border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white transition" maxlength="6">
                <button type="submit" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition shadow-lg shadow-indigo-200 dark:shadow-none">Entrar</button>
            </form>
            <p id="login-error" class="text-red-500 text-xs mt-3 hidden font-bold">C√≥digo incorreto.</p>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 bg-white/90 dark:bg-slate-900/90 flex items-center justify-center z-50 backdrop-blur-sm transition-opacity duration-300 hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 dark:border-indigo-400"></div>
            <p class="mt-4 text-indigo-600 dark:text-indigo-400 font-medium animate-pulse">A carregar dados...</p>
        </div>
    </div>

    <main id="app-content" class="max-w-7xl mx-auto space-y-6 hidden">
       
        <header class="bg-white dark:bg-darkcard p-6 rounded-2xl shadow-sm border-b-4 border-indigo-500 flex justify-between items-center flex-wrap gap-4 transition-colors">
            <div class="flex items-center gap-3">
                <button id="logout-btn" class="p-2 text-slate-400 hover:text-red-500 transition" title="Sair">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                </button>
                <div>
                    <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight">Gestor de Impress√£o</h1>
                    <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">Telmo, Humberto & Empresa</p>
                </div>
            </div>
           
            <div class="flex items-center gap-6">
                <div class="flex gap-4 text-right">
                    <div>
                        <p class="text-xs text-slate-400 uppercase font-bold">Stock Total</p>
                        <p id="total-weight" class="text-xl font-bold text-indigo-600 dark:text-indigo-400">0.000 Kg</p>
                    </div>
                    <div class="border-l pl-4 dark:border-slate-600">
                        <p class="text-xs text-slate-400 uppercase font-bold">Valor Stock</p>
                        <p id="total-value" class="text-xl font-bold text-emerald-600 dark:text-emerald-400">‚Ç¨ 0.00</p>
                    </div>
                </div>
               
                <button id="theme-toggle" class="p-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-yellow-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-all">
                    <svg id="icon-sun" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="icon-moon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white dark:bg-darkcard p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 transition-colors">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-800 dark:text-slate-100">
                        <span class="bg-indigo-100 dark:bg-indigo-900 p-2 rounded-lg text-indigo-600 dark:text-indigo-300">üì¶</span> Registar Bobina
                    </h2>
                    <form id="add-filament-form" class="space-y-3">
                        <input type="text" id="name" placeholder="Nome (Ex: PLA Preto)" required class="w-full p-3 bg-slate-50 dark:bg-darkinput border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition dark:text-white">
                        <div class="grid grid-cols-2 gap-3">
                            <select id="type" required class="p-3 bg-slate-50 dark:bg-darkinput border border-slate-200 dark:border-slate-600 rounded-xl outline-none dark:text-white">
                                <option value="PLA">PLA</option><option value="PETG">PETG</option><option value="ABS">ABS</option><option value="TPU">TPU</option><option value="Outro">Outro</option>
                            </select>
                            <input type="number" id="initial_kg" step="0.01" min="0.1" placeholder="Peso (Kg)" required class="p-3 bg-slate-50 dark:bg-darkinput border border-slate-200 dark:border-slate-600 rounded-xl outline-none dark:text-white">
                        </div>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-slate-400">‚Ç¨</span>
                            <input type="number" id="cost_per_kg" step="0.01" min="0" placeholder="Custo por Kg" required class="w-full p-3 pl-8 bg-slate-50 dark:bg-darkinput border border-slate-200 dark:border-slate-600 rounded-xl outline-none dark:text-white">
                        </div>
                        <button type="submit" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white font-bold rounded-xl transition shadow-lg shadow-indigo-200 dark:shadow-none">Adicionar</button>
                    </form>
                </div>

                <div class="bg-white dark:bg-darkcard p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 relative overflow-hidden transition-colors">
                    <div class="absolute top-0 left-0 w-1 h-full bg-rose-500"></div>
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-800 dark:text-slate-100">
                        <span class="bg-rose-100 dark:bg-rose-900 p-2 rounded-lg text-rose-600 dark:text-rose-300">üñ®Ô∏è</span> Imprimir
                    </h2>
                    <form id="add-project-form" class="space-y-3">
                        <select id="project-user-select" required class="w-full p-3 bg-slate-50 dark:bg-darkinput border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-rose-500 outline-none dark:text-white">
                            <option value="" disabled selected>Quem?</option>
                            <option value="Telmo">Telmo</option><option value="Humberto">Humberto</option><option value="Empresa">Empresa</option>
                        </select>
                        <input type="text" id="project-name" placeholder="Nome do Projeto" required class="w-full p-3 bg-slate-50 dark:bg-darkinput border border-slate-200 dark:border-slate-600 rounded-xl outline-none dark:text-white">
                        <select id="project-filament-select" required class="w-full p-3 bg-slate-50 dark:bg-darkinput border border-slate-200 dark:border-slate-600 rounded-xl outline-none dark:text-white">
                            <option value="" disabled selected>Filamento...</option>
                        </select>
                        <div class="relative">
                            <input type="number" id="grams-required" step="1" min="1" placeholder="Gramas" required class="w-full p-3 bg-slate-50 dark:bg-darkinput border border-slate-200 dark:border-slate-600 rounded-xl outline-none dark:text-white">
                            <span class="absolute right-4 top-3 text-slate-400 text-sm">g</span>
                        </div>
                        <button type="submit" class="w-full py-3 bg-rose-600 hover:bg-rose-700 text-white font-bold rounded-xl transition shadow-lg shadow-rose-200 dark:shadow-none">Registar</button>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-6">
                <div class="bg-white dark:bg-darkcard rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden transition-colors">
                    <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                        <h3 class="font-bold text-slate-700 dark:text-slate-200">Fila de Impress√£o</h3>
                        <span id="pending-count" class="bg-rose-100 dark:bg-rose-900 text-rose-700 dark:text-rose-200 text-xs px-2 py-1 rounded-full font-bold">0</span>
                    </div>
                    <div class="project-table-container">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-700 sticky top-0">
                                <tr><th class="px-6 py-3">Projeto</th><th class="px-6 py-3">User</th><th class="px-6 py-3">Material</th><th class="px-6 py-3 text-right">Peso</th><th class="px-6 py-3 text-center">A√ß√£o</th></tr>
                            </thead>
                            <tbody id="project-list" class="divide-y divide-slate-100 dark:divide-slate-700 dark:text-slate-300">
                                <tr><td colspan="5" class="px-6 py-8 text-center text-slate-400">Vazio.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white dark:bg-darkcard p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 transition-colors">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4">Stock</h3>
                    <div id="filament-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 scrollable-list pr-2"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div id="report-Telmo" class="bg-white dark:bg-darkcard p-5 rounded-2xl shadow-sm border-t-4 border-blue-500 transition-colors"><h4 class="font-bold text-slate-700 dark:text-slate-200 flex justify-between">Telmo <span class="cost text-blue-600 dark:text-blue-400">‚Ç¨0.00</span></h4><p class="text-xs text-slate-400 mt-1 mb-3 total-grams">0g</p><div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3"><ul class="top-mats text-xs space-y-1 text-slate-600 dark:text-slate-300"></ul></div></div>
                    <div id="report-Humberto" class="bg-white dark:bg-darkcard p-5 rounded-2xl shadow-sm border-t-4 border-purple-500 transition-colors"><h4 class="font-bold text-slate-700 dark:text-slate-200 flex justify-between">Humberto <span class="cost text-purple-600 dark:text-purple-400">‚Ç¨0.00</span></h4><p class="text-xs text-slate-400 mt-1 mb-3 total-grams">0g</p><div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3"><ul class="top-mats text-xs space-y-1 text-slate-600 dark:text-slate-300"></ul></div></div>
                    <div id="report-Empresa" class="bg-white dark:bg-darkcard p-5 rounded-2xl shadow-sm border-t-4 border-orange-500 transition-colors"><h4 class="font-bold text-slate-700 dark:text-slate-200 flex justify-between">Empresa <span class="cost text-orange-600 dark:text-orange-400">‚Ç¨0.00</span></h4><p class="text-xs text-slate-400 mt-1 mb-3 total-grams">0g</p><div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3"><ul class="top-mats text-xs space-y-1 text-slate-600 dark:text-slate-300"></ul></div></div>
                </div>

                <div class="bg-white dark:bg-darkcard p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 transition-colors">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4">Hist√≥rico</h3>
                    <div id="history-list" class="space-y-2 scrollable-list"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-white dark:bg-darkcard p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 transform transition-all scale-100 border border-slate-100 dark:border-slate-600">
            <h3 id="modal-title" class="text-lg font-bold text-slate-900 dark:text-white mb-2"></h3>
            <p id="modal-msg" class="text-slate-600 dark:text-slate-300 mb-6 text-sm leading-relaxed"></p>
            <div class="flex justify-end gap-3">
                <button id="modal-cancel" class="px-4 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium hidden transition">Cancelar</button>
                <button id="modal-ok" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium transition shadow-lg shadow-indigo-200 dark:shadow-none">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURA√á√ïES ---
        const SECRET_PIN = "2025"; // <--- O TEU PIN
        const API = '/api';

        // --- Dark Mode (Mantemos em LocalStorage) ---
        const btn = document.getElementById('theme-toggle'), sun=document.getElementById('icon-sun'), moon=document.getElementById('icon-moon');
        const setDark = (d) => { if(d){document.documentElement.classList.add('dark');sun.classList.remove('hidden');moon.classList.add('hidden');}else{document.documentElement.classList.remove('dark');sun.classList.add('hidden');moon.classList.remove('hidden');}};
        if(localStorage.getItem('th')==='d'||(!('th' in localStorage)&&window.matchMedia('(prefers-color-scheme: dark)').matches)) setDark(true); else setDark(false);
        btn.onclick=()=>{const d=document.documentElement.classList.contains('dark'); localStorage.setItem('th',d?'l':'d'); setDark(!d);};

        // --- Login Logic (SESSIONSTORAGE) ---
        const ls=document.getElementById('login-screen'), ac=document.getElementById('app-content');
        if(sessionStorage.getItem('auth')==='1') show();

        document.getElementById('login-form').onsubmit=(e)=>{
            e.preventDefault();
            if(document.getElementById('access-code').value===SECRET_PIN){
                sessionStorage.setItem('auth','1');
                show();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        document.getElementById('logout-btn').onclick=()=>{
            sessionStorage.removeItem('auth');
            location.reload();
        };

        function show(){ls.classList.add('hidden');ac.classList.remove('hidden');start();}

        // --- App Logic ---
        let fils=[], projs=[], hist=[];
        const $=id=>document.getElementById(id);
        const fmtM=v=>`‚Ç¨ ${parseFloat(v).toFixed(2)}`;
        const fmtK=v=>`${(v/1000).toFixed(3)} Kg`;
       
        const modal=(t,m,c=false)=>{
            const md=$('modal'),ok=$('modal-ok'),cx=$('modal-cancel');
            $('modal-title').textContent=t; $('modal-msg').textContent=m; ok.textContent=c?'Confirmar':'OK';
            cx.classList.toggle('hidden',!c); md.classList.remove('hidden'); md.classList.add('flex');
            return new Promise(r=>{
                const end=(v)=>{md.classList.add('hidden');md.classList.remove('flex');ok.replaceWith(ok.cloneNode(true));cx.replaceWith(cx.cloneNode(true));r(v);};
                $('modal-ok').onclick=()=>end(true); $('modal-cancel').onclick=()=>end(false);
            });
        };

        const load=async()=>{
            try{
                const [f,p,h]=await Promise.all([fetch(`${API}/filaments`),fetch(`${API}/projects`),fetch(`${API}/history`)]);
                if(f.ok) fils=await f.json(); if(p.ok) projs=await p.json(); if(h.ok) hist=await h.json();
                render(); $('loading-overlay').classList.add('hidden');
            }catch(e){console.error(e);}
        };

        const render=()=>{
            let totG=0, totE=0; fils.forEach(f=>{totG+=f.remaining_g; totE+=(f.remaining_g/1000)*f.cost_per_kg;});
            $('total-weight').textContent=fmtK(totG); $('total-value').textContent=fmtM(totE);

            const fl=$('filament-list'); fl.innerHTML='';
            fils.sort((a,b)=>b.remaining_g-a.remaining_g).forEach(f=>{
                const p=Math.min(100,Math.max(0,(f.remaining_g/(f.initial_kg*1000))*100)), l=f.remaining_g<100;
                fl.innerHTML+=`<div class="p-4 rounded-xl border ${l?'border-red-200 bg-red-50 dark:bg-red-900/20 dark:border-red-800':'border-slate-100 bg-slate-50 dark:bg-darkinput dark:border-slate-600'} relative group"><div class="flex justify-between items-start mb-2"><div><p class="font-bold text-slate-700 dark:text-white">${f.name}</p><span class="text-[10px] uppercase font-bold bg-white dark:bg-slate-600 px-2 py-1 rounded text-slate-500 dark:text-slate-300 border border-slate-200 dark:border-slate-500">${f.type}</span></div><button onclick="delF('${f.id}','${f.name}')" class="text-slate-300 hover:text-red-500 transition"><svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div><div class="flex justify-between text-sm text-slate-600 dark:text-slate-300 mb-1"><span>${Math.round(f.remaining_g)}g</span><span class="text-slate-400">${p.toFixed(0)}%</span></div><div class="w-full bg-slate-200 dark:bg-slate-600 rounded-full h-1.5 overflow-hidden"><div class="h-full ${l?'bg-red-500':'bg-indigo-500'} transition-all duration-500" style="width:${p}%"></div></div></div>`;
            });

            const sel=$('project-filament-select'), v=sel.value; sel.innerHTML='<option value="" disabled selected>Escolher...</option>';
            fils.filter(f=>f.remaining_g>0).forEach(f=>{const o=document.createElement('option');o.value=f.id;o.textContent=`${f.name} (${Math.round(f.remaining_g)}g)`;sel.appendChild(o);});
            if(v) sel.value=v;

            const pl=$('project-list'); pl.innerHTML=''; $('pending-count').textContent=projs.length;
            if(!projs.length) pl.innerHTML='<tr><td colspan="5" class="px-6 py-8 text-center text-slate-400 dark:text-slate-500">Vazio.</td></tr>';
            else projs.forEach(p=>{
                const fn=fils.find(f=>f.id===p.filamentId)?.name||'Desconhecido';
                pl.innerHTML+=`<tr class="bg-white dark:bg-darkcard hover:bg-slate-50 dark:hover:bg-slate-700 border-b border-slate-100 dark:border-slate-700 transition"><td class="px-6 py-4 font-medium text-slate-900 dark:text-white">${p.projectName}</td><td class="px-6 py-4 text-slate-500 dark:text-slate-400">${p.user}</td><td class="px-6 py-4 text-slate-500 dark:text-slate-400 text-xs">${fn}</td><td class="px-6 py-4 text-right font-mono text-slate-600 dark:text-slate-300">${p.gramsRequired}g</td><td class="px-6 py-4 text-center"><button onclick="conP('${p.id}')" class="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 text-xs font-bold px-3 py-1.5 rounded-full transition">‚úî Concluir</button></td></tr>`;
            });

            const hl=$('history-list'); hl.innerHTML='';
            if(!hist.length) hl.innerHTML='<p class="text-center text-slate-400 py-4">Vazio.</p>';
            else hist.slice(0,20).forEach(h=>{
                hl.innerHTML+=`<div class="flex justify-between items-center p-3 hover:bg-slate-50 dark:hover:bg-slate-700/50 rounded-lg transition border border-transparent hover:border-slate-100 dark:hover:border-slate-700 group"><div><p class="text-sm font-bold text-slate-700 dark:text-slate-200"><span class="${h.user==='Telmo'?'text-blue-500':h.user==='Humberto'?'text-purple-500':'text-orange-500'}">${h.user}</span>: ${h.description}</p><p class="text-xs text-slate-400">Mat: ${h.filamentName||'?'}</p></div><div class="flex items-center gap-3"><div class="text-right"><p class="text-sm font-bold text-slate-700 dark:text-slate-200">${fmtM(h.cost)}</p><p class="text-xs font-mono text-red-500">-${h.gramsUsed}g</p></div><button onclick="delH('${h.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition p-1" title="Anular e Devolver Stock"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div></div>`;
            });

            const st={Telmo:{c:0,g:0,m:{}},Humberto:{c:0,g:0,m:{}},Empresa:{c:0,g:0,m:{}}};
            hist.forEach(h=>{if(st[h.user]){st[h.user].c+=h.cost;st[h.user].g+=h.gramsUsed;const m=h.filamentName||'Outro';st[h.user].m[m]=(st[h.user].m[m]||0)+h.gramsUsed;}});
            ['Telmo','Humberto','Empresa'].forEach(u=>{
                const d=$(`report-${u}`), s=st[u]; d.querySelector('.cost').textContent=fmtM(s.c); d.querySelector('.total-grams').textContent=`${s.g}g`;
                const tm=Object.entries(s.m).sort(([,a],[,b])=>b-a).slice(0,3);
                d.querySelector('.top-mats').innerHTML=tm.length?tm.map(([n,g])=>`<li class="flex justify-between"><span>${n}</span><b>${g}g</b></li>`).join(''):'<li class="italic text-slate-400">--</li>';
            });
        };

        window.delF=async(id,n)=>{if(await modal('Apagar?',`Remover "${n}"?`,true)){await fetch(`${API}/filaments/${id}`,{method:'DELETE'});load();}};
        window.delH=async(id)=>{if(await modal('Anular?',`Apagar registo e DEVOLVER gramas ao stock?`,true)){const r=await fetch(`${API}/history?id=${id}`,{method:'DELETE'});if(r.ok)load();else modal('Erro','Falha');}};
        window.conP=async(id)=>{if(await modal('Concluir?',`Confirmar?`,true)){const r=await fetch(`${API}/projects/complete`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({projectId:id})});if(r.ok)load();else modal('Erro',(await r.json()).error);}};

        $('add-filament-form').onsubmit=async(e)=>{e.preventDefault();await fetch(`${API}/filaments`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:$('name').value,type:$('type').value,initial_kg:$('initial_kg').value,cost_per_kg:$('cost_per_kg').value,userId:'Admin'})});e.target.reset();load();};
        $('add-project-form').onsubmit=async(e)=>{e.preventDefault();const fid=$('project-filament-select').value, f=fils.find(i=>i.id===fid); if(f&&f.remaining_g<$('grams-required').value)return modal('Stock Baixo',`S√≥ restam ${f.remaining_g}g`); await fetch(`${API}/projects`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user:$('project-user-select').value,projectName:$('project-name').value,filamentId:fid,gramsRequired:$('grams-required').value,costPerKg:f.cost_per_kg,userId:'Admin'})});e.target.reset();load();};

        function start(){load();setInterval(load,4000);}
    </script>
</body>
</html>